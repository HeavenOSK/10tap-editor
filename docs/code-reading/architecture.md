# アーキテクチャ概要

## 高レベルアーキテクチャ

このプロジェクトは、ネイティブプラットフォームの機能とWeb技術を組み合わせたハイブリッドアプローチを使用して、React Native向けのリッチテキストエディタを実装しています。

```
+------------------------+
|    React Nativeアプリ  |
|  +------------------+ |
|  |   WebView       | |
|  |  +-----------+  | |
|  |  |  TipTap   |  | |
|  |  | エディタ    |  | |
|  |  +-----------+  | |
|  +------------------+ |
+------------------------+
```

## 主要コンポーネント

### 1. ネイティブブリッジ層
`/ios`と`/android`ディレクトリに配置され、以下の機能を提供：
- ネイティブプラットフォームとの統合
- WebViewのライフサイクル管理
- ネイティブUIコンポーネントの提供
- プラットフォーム固有機能の処理

### 2. React Native層
`/src/RichText`に配置され、以下の機能を提供：
- React Nativeコンポーネントインターフェースの管理
- 状態管理
- React Nativeアプリケーション向けのエディタAPI提供
- ネイティブとWeb層間の通信管理

### 3. Webエディタ層
`/src/simpleWebEditor`に配置され、以下を実装：
- TipTapエディタの統合
- リッチテキスト編集機能
- HTMLレンダリング
- エディタの状態管理

### 4. ブリッジ層
`/src/bridges`に配置され、以下の機能を提供：
- React NativeとWeb層間の通信管理
- 状態同期の処理
- TipTap機能のための拡張ブリッジ提供

## データフロー

```
+----------------+     +----------------+     +----------------+
|  React Native  | --> |    ブリッジ    | --> |   Webエディタ  |
|  コンポーネント | <-- |    レイヤー    | <-- |   (TipTap)   |
+----------------+     +----------------+     +----------------+
```

1. React Nativeでのユーザー操作がイベントを発生
2. イベントがブリッジ層を通過
3. Webエディタがイベントを処理してコンテンツを更新
4. 変更がブリッジを通じて同期
5. React Nativeコンポーネントが状態を更新

## 主要機能の実装

### リッチテキスト編集
- TipTap拡張機能を使用して実装
- 各機能（太字、斜体、リストなど）は独自の拡張機能を持つ
- 拡張機能はブリッジ層を通じてReact Nativeと連携

### 状態管理
- エディタの状態はWeb層で管理
- 状態の変更はReact Nativeと同期
- 双方向通信により一貫性を確保

### プラットフォーム統合
- プラットフォーム固有機能用のネイティブUIコンポーネント
- エディタ表示のためのWebView管理
- ネイティブイベント処理とコールバック

## ビルドプロセス

1. TypeScriptのコンパイル
2. Webエディタのバンドリング（Vite）
3. React Nativeのバンドリング
4. プラットフォーム固有のビルド（iOS/Android）

## 拡張機能システム

エディタの機能はTipTap拡張機能を通じて拡張されます：

```
+-------------------+
|  基本エディタ     |
+-------------------+
        |
+-------------------+
|  コア拡張機能     |
+-------------------+
        |
+-------------------+
| カスタム拡張機能  |
+-------------------+
```

### 拡張機能カテゴリ
1. コア拡張機能
   - 文書構造
   - 基本的な書式設定
   - 履歴管理

2. 書式設定拡張機能
   - テキストスタイリング
   - 段落書式設定
   - リストとインデント

3. 特殊機能
   - 画像
   - リンク
   - コードブロック
   - タスクリスト

## パフォーマンスに関する考慮事項

1. WebView最適化
   - 最小限のDOM更新
   - 効率的な状態同期
   - 拡張機能の遅延読み込み

2. ネイティブブリッジ
   - 一括更新
   - 効率的なメッセージ受け渡し
   - メモリ管理

3. 状態管理
   - 最適化された更新サイクル
   - 選択的な再レンダリング
   - キャッシュされた状態管理

## セキュリティに関する考慮事項

1. コンテンツサニタイズ
   - HTMLサニタイズ
   - 入力値検証
   - XSS防止

2. WebViewセキュリティ
   - JavaScript実行の制限
   - コンテンツセキュリティポリシー
   - 安全な通信チャネル

## テスト戦略

1. ユニットテスト
   - 個別コンポーネントのテスト
   - 拡張機能のテスト
   - ブリッジ層のテスト

2. 統合テスト
   - クロスプラットフォーム機能
   - WebView統合
   - 状態同期

3. エンドツーエンドテスト
   - エディタ全体の機能
   - プラットフォーム固有の機能
   - ユーザー操作フロー
